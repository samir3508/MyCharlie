// ===============================
// L√âO ROUTER TOOL ‚Äî VERSION CLEAN
// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();


// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();

// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();


// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();

// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();


// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();

// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();


// ===============================

// Ce que l'agent envoie est D√âJ√Ä un objet
const input = $input.item.json;

// Extraire depuis query si pr√©sent, sinon depuis la racine
const { action, payload = {}, tenant_id } = input.query || input;

// DEBUG
console.log('üîç INPUT:', JSON.stringify(input, null, 2));
console.log('üîç action:', action);
console.log('üîç payload:', payload);
console.log('üîç tenant_id:', tenant_id);

// VALIDATION
if (!action) {
  throw new Error('‚ùå action manquante. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}
if (!tenant_id) {
  throw new Error('‚ùå tenant_id manquant. Structure re√ßue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions fran√ßais ‚Üí anglais (si n√©cessaire)
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// BODY POUR SUPABASE - Appel direct √† l'edge function
const requestBody = {
  ...payload,
  tenant_id
};

// APPEL EDGE FUNCTION DIRECTEMENT (pas via leo-router)
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = `${BASE_URL}/${normalizedAction}`;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  const text = await response.text();
  throw new Error(`‚ùå ${normalizedAction} error (${response.status}): ${text}`);
}

// IMPORTANT : retourner UN OBJET
return await response.json();