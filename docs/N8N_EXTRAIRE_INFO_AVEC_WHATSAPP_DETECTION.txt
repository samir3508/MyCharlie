// Code SIMPLIFIÃ‰ et ROBUSTE pour le nÅ“ud "extraire info de la demande"
// GÃ¨re les sauts de ligne et tous les formats (x, Ã—, forfait, etc.)

const items = $input.all();
const body = items[0]?.json?.body || {};

// ===============================
// 1ï¸âƒ£ RÃ‰CUPÃ‰RER LE MESSAGE Ã€ PARSER
// ===============================

let message = '';
if (body.history && Array.isArray(body.history) && body.history.length > 0) {
  const firstUserMessage = body.history.find(msg => msg.role === 'user');
  if (firstUserMessage && firstUserMessage.content) {
    message = firstUserMessage.content;
  }
}

if (!message) {
  message = body.raw_message || body.message || '';
}

// ===============================
// 2ï¸âƒ£ TENANT + DATE
// ===============================
const tenantId = body.context?.tenant_id || 'f117dc59-1cef-41c3-91a3-8c12d47f6bfb';
const now = new Date();
const todayDate = now.toISOString().slice(0, 10);

// ===============================
// 3ï¸âƒ£ DÃ‰TECTION WHATSAPP (AJOUTÃ‰)
// ===============================
// DÃ©tecter si le message vient de WhatsApp en vÃ©rifiant body.From
const fromPhone = body.From || '';
const isWhatsApp = fromPhone.includes('whatsapp:') || body.is_whatsapp === true;

// ===============================
// 4ï¸âƒ£ EXTRACTION CLIENT
// ===============================

const nameMatch = message.match(/devis pour\s+([A-Za-zÃ€-Ã¿\s'-]+)/i);
const clientName = nameMatch ? nameMatch[1].trim() : null;

let prenom = null;
let nom = null;
if (clientName) {
  const nameParts = clientName.split(/\s+/);
  prenom = nameParts[0];
  nom = nameParts.slice(1).join(" ") || nameParts[0];
}

const addressMatch = message.match(/,\s*(\d{1,3}[^,\n]+,\s*\d{5}\s*[A-Za-zÃ€-Ã¿\s-]+)/);
const address = addressMatch ? addressMatch[1].trim() : null;

const phoneMatch = message.match(/(0\d(?:[\s.-]?\d{2}){4})/);
const phone = phoneMatch ? phoneMatch[1].replace(/\s+/g, '') : null;

const emailMatch = message.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
const email = emailMatch ? emailMatch[0] : null;

// ===============================
// 5ï¸âƒ£ EXTRACTION DES LIGNES DE TRAVAUX (VERSION SIMPLIFIÃ‰E ET ROBUSTE)
// ===============================
const lines = [];

// Ã‰TAPE 1 : Normaliser le message (remplacer tous les sauts de ligne par des espaces)
const normalizedMsg = message
  .replace(/\r\n/g, ' ')
  .replace(/\r/g, ' ')
  .replace(/\n/g, ' ')
  .replace(/\t/g, ' ')
  .replace(/\s+/g, ' ')
  .trim();

console.log('ðŸ“ Message normalisÃ© (200 premiers caractÃ¨res):', normalizedMsg.substring(0, 200));

// Ã‰TAPE 2 : Chercher les lignes avec pattern simple mais robuste
// Pattern FORFAIT : "... â†’ forfait XXX â‚¬ ... TVA YY%"
const forfaitRegex = /([A-Za-zÃ€-Ã¿\s-]+?)\s*â†’\s*forfait\s+(\d+(?:[.,]\d+)?)\s*â‚¬[^â‚¬]*?TVA\s*(\d+)%/gi;
let match;
while ((match = forfaitRegex.exec(normalizedMsg)) !== null) {
  const label = match[1].trim();
  const prix = parseFloat(match[2].replace(',', '.'));
  const tva = parseInt(match[3], 10);
  
  if (!lines.find(l => l.label === label && l.unit_price === prix)) {
    lines.push({
      label: label,
      quantity: 1,
      unit: 'forfait',
      unit_price: prix,
      tva: tva
    });
  }
}

// Pattern QUANTITÃ‰ Ã— PRIX : "... â†’ XXX mÂ² x YYY â‚¬ ... TVA ZZ%"
// GÃ¨re "x" (lettre), "Ã—" (symbole), "X" (majuscule)
const qtyPriceRegex = /([A-Za-zÃ€-Ã¿\s-]+?)\s*â†’\s*(\d+(?:[.,]\d+)?)\s+(mÂ²|ml|m|u\.|unitÃ©)\s*[Ã—xX]\s*(\d+(?:[.,]\d+)?)\s*â‚¬[^â‚¬]*?TVA\s*(\d+)%/gi;
while ((match = qtyPriceRegex.exec(normalizedMsg)) !== null) {
  const label = match[1].trim();
  const qty = parseFloat(match[2].replace(',', '.'));
  const unit = match[3];
  const prix = parseFloat(match[4].replace(',', '.'));
  const tva = parseInt(match[5], 10);
  
  if (!lines.find(l => l.label === label && l.quantity === qty && l.unit_price === prix)) {
    lines.push({
      label: label,
      quantity: qty,
      unit: unit,
      unit_price: prix,
      tva: tva
    });
  }
}

// DEBUG
console.log(`âœ… ${lines.length} ligne(s) de travaux extraite(s)`);
lines.forEach((line, idx) => {
  console.log(`  ${idx + 1}. ${line.label} - ${line.quantity} ${line.unit} Ã— ${line.unit_price} â‚¬ (TVA ${line.tva}%)`);
});

// ===============================
// 6ï¸âƒ£ STRUCTURE FINALE
// ===============================
return {
  json: {
    body: {
      raw_message: message,
      client: {
        name: clientName,
        prenom: prenom,
        nom: nom,
        address: address,
        phone: phone,
        email: email
      },
      travaux: lines.length > 0 ? lines : null,
      context: {
        tenant_id: tenantId,
        conversation_date: todayDate,
        is_whatsapp: isWhatsApp  // âœ… DÃ‰TECTION CORRIGÃ‰E
      }
    }
  }
};



const items = $input.all();
const body = items[0]?.json?.body || {};

// ===============================
// 1ï¸âƒ£ RÃ‰CUPÃ‰RER LE MESSAGE Ã€ PARSER
// ===============================

let message = '';
if (body.history && Array.isArray(body.history) && body.history.length > 0) {
  const firstUserMessage = body.history.find(msg => msg.role === 'user');
  if (firstUserMessage && firstUserMessage.content) {
    message = firstUserMessage.content;
  }
}

if (!message) {
  message = body.raw_message || body.message || '';
}

// ===============================
// 2ï¸âƒ£ TENANT + DATE
// ===============================
const tenantId = body.context?.tenant_id || 'f117dc59-1cef-41c3-91a3-8c12d47f6bfb';
const now = new Date();
const todayDate = now.toISOString().slice(0, 10);

// ===============================
// 3ï¸âƒ£ DÃ‰TECTION WHATSAPP (AJOUTÃ‰)
// ===============================
// DÃ©tecter si le message vient de WhatsApp en vÃ©rifiant body.From
const fromPhone = body.From || '';
const isWhatsApp = fromPhone.includes('whatsapp:') || body.is_whatsapp === true;

// ===============================
// 4ï¸âƒ£ EXTRACTION CLIENT
// ===============================

const nameMatch = message.match(/devis pour\s+([A-Za-zÃ€-Ã¿\s'-]+)/i);
const clientName = nameMatch ? nameMatch[1].trim() : null;

let prenom = null;
let nom = null;
if (clientName) {
  const nameParts = clientName.split(/\s+/);
  prenom = nameParts[0];
  nom = nameParts.slice(1).join(" ") || nameParts[0];
}

const addressMatch = message.match(/,\s*(\d{1,3}[^,\n]+,\s*\d{5}\s*[A-Za-zÃ€-Ã¿\s-]+)/);
const address = addressMatch ? addressMatch[1].trim() : null;

const phoneMatch = message.match(/(0\d(?:[\s.-]?\d{2}){4})/);
const phone = phoneMatch ? phoneMatch[1].replace(/\s+/g, '') : null;

const emailMatch = message.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
const email = emailMatch ? emailMatch[0] : null;

// ===============================
// 5ï¸âƒ£ EXTRACTION DES LIGNES DE TRAVAUX (VERSION SIMPLIFIÃ‰E ET ROBUSTE)
// ===============================
const lines = [];

// Ã‰TAPE 1 : Normaliser le message (remplacer tous les sauts de ligne par des espaces)
const normalizedMsg = message
  .replace(/\r\n/g, ' ')
  .replace(/\r/g, ' ')
  .replace(/\n/g, ' ')
  .replace(/\t/g, ' ')
  .replace(/\s+/g, ' ')
  .trim();

console.log('ðŸ“ Message normalisÃ© (200 premiers caractÃ¨res):', normalizedMsg.substring(0, 200));

// Ã‰TAPE 2 : Chercher les lignes avec pattern simple mais robuste
// Pattern FORFAIT : "... â†’ forfait XXX â‚¬ ... TVA YY%"
const forfaitRegex = /([A-Za-zÃ€-Ã¿\s-]+?)\s*â†’\s*forfait\s+(\d+(?:[.,]\d+)?)\s*â‚¬[^â‚¬]*?TVA\s*(\d+)%/gi;
let match;
while ((match = forfaitRegex.exec(normalizedMsg)) !== null) {
  const label = match[1].trim();
  const prix = parseFloat(match[2].replace(',', '.'));
  const tva = parseInt(match[3], 10);
  
  if (!lines.find(l => l.label === label && l.unit_price === prix)) {
    lines.push({
      label: label,
      quantity: 1,
      unit: 'forfait',
      unit_price: prix,
      tva: tva
    });
  }
}

// Pattern QUANTITÃ‰ Ã— PRIX : "... â†’ XXX mÂ² x YYY â‚¬ ... TVA ZZ%"
// GÃ¨re "x" (lettre), "Ã—" (symbole), "X" (majuscule)
const qtyPriceRegex = /([A-Za-zÃ€-Ã¿\s-]+?)\s*â†’\s*(\d+(?:[.,]\d+)?)\s+(mÂ²|ml|m|u\.|unitÃ©)\s*[Ã—xX]\s*(\d+(?:[.,]\d+)?)\s*â‚¬[^â‚¬]*?TVA\s*(\d+)%/gi;
while ((match = qtyPriceRegex.exec(normalizedMsg)) !== null) {
  const label = match[1].trim();
  const qty = parseFloat(match[2].replace(',', '.'));
  const unit = match[3];
  const prix = parseFloat(match[4].replace(',', '.'));
  const tva = parseInt(match[5], 10);
  
  if (!lines.find(l => l.label === label && l.quantity === qty && l.unit_price === prix)) {
    lines.push({
      label: label,
      quantity: qty,
      unit: unit,
      unit_price: prix,
      tva: tva
    });
  }
}

// DEBUG
console.log(`âœ… ${lines.length} ligne(s) de travaux extraite(s)`);
lines.forEach((line, idx) => {
  console.log(`  ${idx + 1}. ${line.label} - ${line.quantity} ${line.unit} Ã— ${line.unit_price} â‚¬ (TVA ${line.tva}%)`);
});

// ===============================
// 6ï¸âƒ£ STRUCTURE FINALE
// ===============================
return {
  json: {
    body: {
      raw_message: message,
      client: {
        name: clientName,
        prenom: prenom,
        nom: nom,
        address: address,
        phone: phone,
        email: email
      },
      travaux: lines.length > 0 ? lines : null,
      context: {
        tenant_id: tenantId,
        conversation_date: todayDate,
        is_whatsapp: isWhatsApp  // âœ… DÃ‰TECTION CORRIGÃ‰E
      }
    }
  }
};
