const input = $input.item.json;

let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;

let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;
let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;

let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;
let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;

let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;
let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;

let action, payload, tenant_id;

// Essayer TOUS les formats possibles, dans l'ordre de priorité
if (input.query) {
  // Format 1 : query.parameters.*
  if (input.query.parameters && input.query.parameters.action) {
    action = input.query.parameters.action;
    payload = input.query.parameters.payload || {};
    tenant_id = input.query.parameters.tenant_id || input.query.tenant_id || input.tenant_id;
  }
  // Format 2 : query.query.*
  else if (input.query.query && input.query.query.action) {
    action = input.query.query.action;
    payload = input.query.query.payload || {};
    tenant_id = input.tenant_id || input.query.tenant_id || input.query.query.tenant_id;
  }
  // Format 3 : query.action (direct dans query)
  else if (input.query.action) {
    action = input.query.action;
    payload = input.query.payload || {};
    tenant_id = input.query.tenant_id || input.tenant_id;
  }
}
// Format 4 : action direct (niveau racine)
else if (input.action) {
  action = input.action;
  payload = input.payload || {};
  tenant_id = input.tenant_id;
}

// Validation
if (!action) {
  throw new Error('Action manquante. Structure reçue: ' + JSON.stringify(input, null, 2));
}

if (!tenant_id) {
  throw new Error('tenant_id manquant. Structure reçue: ' + JSON.stringify(input, null, 2));
}

// Conversion actions français → anglais
const actionMap = {
  'chercher-client': 'search-client',
  'recherche-client': 'search-client',
  'creer-client': 'create-client',
  'obtenir-client': 'get-client',
  'lister-clients': 'list-clients',
  'modifier-client': 'update-client',
  'supprimer-client': 'delete-client',
  'creer-devis': 'create-devis',
  'ajouter-ligne-devis': 'add-ligne-devis',
  'modifier-ligne-devis': 'update-ligne-devis',
  'supprimer-ligne-devis': 'delete-ligne-devis',
  'finaliser-devis': 'finalize-devis',
  'envoyer-devis': 'send-devis',
  'obtenir-devis': 'get-devis',
  'lister-devis': 'list-devis',
  'modifier-devis': 'update-devis',
  'supprimer-devis': 'delete-devis',
  'creer-facture': 'create-facture',
  'ajouter-ligne-facture': 'add-ligne-facture',
  'modifier-ligne-facture': 'update-ligne-facture',
  'supprimer-ligne-facture': 'delete-ligne-facture',
  'finaliser-facture': 'finalize-facture',
  'envoyer-facture': 'send-facture',
  'marquer-facture-payee': 'mark-facture-paid',
  'envoyer-relance': 'send-relance',
  'obtenir-facture': 'get-facture',
  'lister-factures': 'list-factures',
  'modifier-facture': 'update-facture',
  'supprimer-facture': 'delete-facture',
  'statistiques': 'stats-dashboard',
  'stats': 'stats-dashboard',
  'dashboard': 'stats-dashboard',
  'recherche-globale': 'search-global',
  'recherche': 'search-global'
};

const normalizedAction = actionMap[action] || action;

// Construction du body
const requestBody = {};
if (payload && typeof payload === 'object') {
  for (var key in payload) {
    if (payload.hasOwnProperty(key)) {
      requestBody[key] = payload[key];
    }
  }
}
requestBody.tenant_id = tenant_id;

// Appel edge function
const LEO_API_SECRET = 'bfcce0dca821fbf3d0f0303e90710bf7b24882d8418f276ee30fe7906ba0bf22';
const BASE_URL = 'https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1';
const functionUrl = BASE_URL + '/' + normalizedAction;

const response = await fetch(functionUrl, {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + LEO_API_SECRET,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestBody)
});

if (!response.ok) {
  // Essayer de parser l'erreur comme JSON pour récupérer les détails
  let errorData;
  try {
    const errorText = await response.text();
    errorData = JSON.parse(errorText);
  } catch (e) {
    // Si ce n'est pas du JSON, créer une erreur basique
    errorData = {
      success: false,
      code: 'API_ERROR',
      message: 'Erreur ' + normalizedAction + ' (' + response.status + ')'
    };
  }
  
  // Retourner l'erreur dans un format structuré pour que LÉO puisse accéder aux détails
  return {
    success: false,
    message: 'Erreur API',
    status: response.status,
    action: normalizedAction,
    details: errorData  // Les détails (factures_existantes, prochain_type_suggere, etc.) sont ici
  };
}

const result = await response.json();
return result;