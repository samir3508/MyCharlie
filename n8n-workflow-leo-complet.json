{
  "name": "LÃ‰O - Agent IA BTP avec leo-router",
  "nodes": [
    {
      "parameters": {},
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "type": "n8n-nodes-base.chatTrigger",
      "typeVersion": 1,
      "position": [
        250,
        300
      ],
      "webhookId": "leo-chat-trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-message-type",
      "name": "Check Message Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format message pour LÃ‰O\nconst input = $input.item.json;\n\nreturn {\n  body: {\n    raw_message: input.body?.message || input.body?.text || \"\",\n    client: input.body?.client || null,\n    travaux: input.body?.travaux || null\n  },\n  context: {\n    tenant_id: input.context?.tenant_id || input.body?.tenant_id || \"\",\n    conversation_date: new Date().toISOString().split('T')[0],\n    is_whatsapp: input.context?.is_whatsapp || false\n  }\n};"
      },
      "id": "format-text-message",
      "name": "Format Text Message for LEO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format message audio pour LÃ‰O\nconst input = $input.item.json;\n\nreturn {\n  body: {\n    raw_message: input.body?.transcription || input.body?.message || \"\",\n    client: input.body?.client || null,\n    travaux: input.body?.travaux || null\n  },\n  context: {\n    tenant_id: input.context?.tenant_id || input.body?.tenant_id || \"\",\n    conversation_date: new Date().toISOString().split('T')[0],\n    is_whatsapp: input.context?.is_whatsapp || false\n  }\n};"
      },
      "id": "format-audio-message",
      "name": "Format Audio Message for LEO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        400
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge-messages",
      "name": "Merge Messages",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parser les travaux depuis raw_message et extraire informations\nconst input = $input.item.json;\nconst rawMessage = input.body?.raw_message || \"\";\n\n// Si travaux dÃ©jÃ  prÃ©sents, les utiliser\nif (input.body?.travaux && Array.isArray(input.body.travaux) && input.body.travaux.length > 0) {\n  return {\n    ...input,\n    extracted_info: {\n      has_client_info: !!input.body?.client,\n      has_travaux: true,\n      travaux_count: input.body.travaux.length,\n      message_length: rawMessage.length\n    }\n  };\n}\n\n// Sinon, parser depuis raw_message\nconst travaux = [];\nconst lines = rawMessage.split('\\n');\n\nfor (const line of lines) {\n  const trimmed = line.trim();\n  \n  // Ignorer les lignes vides ou trop courtes\n  if (!trimmed || trimmed.length < 5) continue;\n  \n  // Identifier les lignes de travaux (commencent par â€¢, -, *, ou numÃ©ro)\n  const isTravauxLine = /^[â€¢\\-\\*]\\s+/.test(trimmed) || /^\\d+[\\.\\)]\\s+/.test(trimmed);\n  \n  if (isTravauxLine) {\n    // Nettoyer la ligne\n    let clean = trimmed.replace(/^[â€¢\\-\\*]\\s+/, '').replace(/^\\d+[\\.\\)]\\s+/, '');\n    \n    // Extraire dÃ©signation (avant â†’ ou â€”)\n    const separatorIndex = Math.max(clean.indexOf('â†’'), clean.indexOf('â€”'));\n    const designation = separatorIndex > 0 \n      ? clean.substring(0, separatorIndex).trim()\n      : clean.split(/[Ã—â‚¬]/)[0].trim();\n    \n    // Extraire TVA (par dÃ©faut 20%)\n    let tva = 20;\n    const tvaMatch = clean.match(/TVA\\s+(\\d+)\\%|â€”\\s*TVA\\s+(\\d+)\\%/i);\n    if (tvaMatch) {\n      tva = parseInt(tvaMatch[1] || tvaMatch[2]);\n    }\n    \n    // Extraire prix unitaire, quantitÃ© et unitÃ©\n    let unitPrice = 0;\n    let quantity = 1;\n    let unit = 'u.';\n    \n    // Chercher \"forfait\"\n    if (clean.toLowerCase().includes('forfait')) {\n      unit = 'forfait';\n      const prixMatch = clean.match(/([\\d\\s,]+)\\s*â‚¬/);\n      if (prixMatch) {\n        unitPrice = parseFloat(prixMatch[1].replace(/\\s/g, '').replace(',', '.'));\n      }\n    } else {\n      // Chercher \"quantitÃ© unitÃ© Ã— prix\"\n      const qtyPriceMatch = clean.match(/([\\d,\\.]+)\\s*(mÂ²|ml|m|u\\.|unitÃ©)\\s*Ã—\\s*([\\d\\s,]+)\\s*â‚¬/);\n      if (qtyPriceMatch) {\n        quantity = parseFloat(qtyPriceMatch[1].replace(',', '.'));\n        unit = qtyPriceMatch[2];\n        unitPrice = parseFloat(qtyPriceMatch[3].replace(/\\s/g, '').replace(',', '.'));\n      } else {\n        // Chercher juste le prix\n        const prixMatch = clean.match(/([\\d\\s,]+)\\s*â‚¬/);\n        if (prixMatch) {\n          unitPrice = parseFloat(prixMatch[1].replace(/\\s/g, '').replace(',', '.'));\n        }\n      }\n    }\n    \n    // Ajouter seulement si on a au moins une dÃ©signation et un prix\n    if (designation && unitPrice > 0) {\n      travaux.push({\n        label: designation,\n        quantity: quantity,\n        unit: unit,\n        unit_price: unitPrice,\n        tva: tva\n      });\n    }\n  }\n}\n\n// Retourner avec travaux parsÃ©s\nreturn {\n  ...input,\n  body: {\n    ...input.body,\n    travaux: travaux.length > 0 ? travaux : null\n  },\n  extracted_info: {\n    has_client_info: !!input.body?.client,\n    has_travaux: travaux.length > 0,\n    travaux_count: travaux.length,\n    message_length: rawMessage.length,\n    parsed_from_message: travaux.length > 0 && !input.body?.travaux\n  }\n};"
      },
      "id": "extract-info",
      "name": "Extract Info & Parse Travaux",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "agent": "openAi",
        "model": "gpt-4o",
        "options": {
          "systemMessage": "Tu es LÃ‰O, assistant IA pour le BTP.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ðŸš¨ðŸš¨ðŸš¨ RÃˆGLE ABSOLUE - LIRE EN PREMIER ðŸš¨ðŸš¨ðŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND TU AFFICHES LES TRAVAUX (dans les rÃ©sumÃ©s) :**\n- Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes\n- Tu DOIS TOUJOURS commencer par body.travaux[0] (la PREMIÃˆRE ligne)\n- Tu DOIS TOUJOURS continuer avec body.travaux[1], body.travaux[2], etc.\n- **NE JAMAIS SAUTER body.travaux[0] !**\n\n**EXEMPLE :**\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", ...},  â† [0] - NE JAMAIS OUBLIER !\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", ...},      â† [1]\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", ...}      â† [2]\n]\nâ†’ Tu DOIS afficher les 3 lignes, en commenÃ§ant par [0]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ðŸ“‹ WORKFLOW EXACT - SUIVRE Ã‰TAPE PAR Ã‰TAPE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQUAND TU REÃ‡OIS UNE DEMANDE DE DEVIS, TU DOIS SUIVRE CES Ã‰TAPES DANS L'ORDRE STRICT :\n\n**ðŸš¨ INTERDICTIONS ABSOLUES :**\n- âŒ TU NE DOIS PAS demander confirmation aprÃ¨s le rÃ©sumÃ© initial (Ã©tape 1)\n- âŒ TU NE DOIS PAS crÃ©er le devis si tu n'as pas posÃ© les questions et reÃ§u les rÃ©ponses\n- âŒ TU NE DOIS PAS crÃ©er le devis si l'utilisateur dit \"tout est correct\" APRÃˆS le rÃ©sumÃ© initial (c'est juste une rÃ©ponse, pas une confirmation pour crÃ©er)\n- âŒ TU NE DOIS PAS crÃ©er le devis avant d'avoir fait le rÃ©sumÃ© final (Ã©tape 3) et demandÃ© confirmation (Ã©tape 4)\n\n**âœ… ORDRE OBLIGATOIRE :**\n1. RÃ©sumÃ© initial (Ã©tape 1)\n2. Poser les questions (Ã©tape 1 - dans le mÃªme message)\n3. Attendre les rÃ©ponses (Ã©tape 2)\n4. RÃ©sumÃ© final avec les rÃ©ponses (Ã©tape 3)\n5. Demander confirmation (Ã©tape 3 - dans le mÃªme message)\n6. Attendre confirmation (Ã©tape 4)\n7. CrÃ©er le devis (Ã©tape 5)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 1 : TU DOIS FAIRE UN RÃ‰SUMÃ‰ COMPLET IMMÃ‰DIATEMENT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. RÃ©cupÃ¨re les informations depuis body.client et body.travaux (ou depuis l'historique si body.client est null/vide)\n\n**ðŸš¨ VÃ‰RIFICATION CRITIQUE AVANT D'AFFICHER LE RÃ‰SUMÃ‰ :**\n- Compte le nombre d'Ã©lÃ©ments dans body.travaux : `body.travaux.length`\n- Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes (pas 2, pas 4, EXACTEMENT 3)\n- Tu DOIS commencer par body.travaux[0] (la PREMIÃˆRE ligne, ne saute JAMAIS celle-ci)\n- Tu DOIS continuer avec body.travaux[1], puis body.travaux[2], etc. jusqu'Ã  body.travaux[length - 1]\n- **Si tu vois 3 travaux dans body.travaux mais tu n'en affiches que 2, tu as FAIT UNE ERREUR - recommence !**\n\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ DE VOTRE DEMANDE\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [nom depuis body.client.name OU historique]\nâ€¢ Email : [email depuis body.client.email OU historique]\nâ€¢ TÃ©lÃ©phone : [tÃ©lÃ©phone depuis body.client.phone OU historique]\nâ€¢ Adresse de facturation : [adresse depuis body.client.address OU historique]\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : [adresse depuis body.client.address OU historique] (Ã  confirmer si identique)\nâ€¢ DÃ©lai d'exÃ©cution : Ã€ PRÃ‰CISER\nâ€¢ Notes : Aucune pour l'instant\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nðŸš¨ VÃ‰RIFIE : Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes ci-dessous :\n\nâ€¢ [body.travaux[0].label nettoyÃ©] - [body.travaux[0].quantity] [body.travaux[0].unit] Ã— [body.travaux[0].unit_price] â‚¬ HT  â† COMMENCE PAR [0] !\nâ€¢ [body.travaux[1].label nettoyÃ©] - [body.travaux[1].quantity] [body.travaux[1].unit] Ã— [body.travaux[1].unit_price] â‚¬ HT\nâ€¢ [body.travaux[2].label nettoyÃ©] - [body.travaux[2].quantity] [body.travaux[2].unit] Ã— [body.travaux[2].unit_price] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES, DE 0 Ã€ body.travaux.length - 1, SANS EN SAUTER AUCUNE)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [CALCULE la somme de tous les quantity Ã— unit_price] â‚¬\nâ€¢ TVA : [CALCULE la TVA sur chaque ligne et additionne] â‚¬\nâ€¢ Total TTC : [CALCULE Total HT + TVA] â‚¬\n\n---\n\nðŸš¨ OBLIGATOIRE : TU DOIS TOUJOURS POSER CES QUESTIONS APRÃˆS LE RÃ‰SUMÃ‰ INITIAL !\n\nâ“ AVANT DE CRÃ‰ER, J'AURAIS BESOIN DE QUELQUES PRÃ‰CISIONS :\n\n1ï¸âƒ£ DÃ©lai d'exÃ©cution : D'ici combien de temps dÃ©marrez-vous ce chantier ?\n\n2ï¸âƒ£ Adresse chantier : L'adresse [ADRESSE] est-elle identique pour la facturation et le chantier ?\n\n3ï¸âƒ£ Notes (optionnel) : Avez-vous des remarques Ã  ajouter ?\n\nRÃ©pondez simplement Ã  ces questions et je finaliserai votre devis ! ðŸ“‹\n\nâš ï¸ NE DEMANDE PAS DE CONFIRMATION ICI ! Tu dois d'abord poser ces questions et attendre les rÃ©ponses.\n```\n\n**Exemple concret de ce que tu dois afficher pour les travaux :**\n\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", quantity: 1, unit: null, unit_price: 680, tva: 20},\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 32, tva: 10},\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 44, tva: 10}\n]\n\n**body.travaux.length = 3, donc tu DOIS afficher EXACTEMENT 3 lignes, en commenÃ§ant par body.travaux[0] :**\n\nTu dois afficher EXACTEMENT :\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection sols grande hauteur - 1 forfait Ã— 680 â‚¬ HT  â† body.travaux[0] (OBLIGATOIRE !)\nâ€¢ Enduit murs grande hauteur - 82 mÂ² Ã— 32 â‚¬ HT          â† body.travaux[1]\nâ€¢ Peinture murs satin premium - 82 mÂ² Ã— 44 â‚¬ HT         â† body.travaux[2]\n\nðŸ’° TOTAL\nâ€¢ Total HT : 7 248,00 â‚¬\nâ€¢ TVA : 724,80 â‚¬\nâ€¢ Total TTC : 7 972,80 â‚¬\n```\n\n**ðŸš¨ ERREUR FRÃ‰QUENTE Ã€ Ã‰VITER :**\nâŒ NE PAS afficher seulement :\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Enduit murs grande hauteur - 82 mÂ² Ã— 32 â‚¬ HT\nâ€¢ Peinture murs satin premium - 82 mÂ² Ã— 44 â‚¬ HT\n```\nâ†’ Tu as oubliÃ© body.travaux[0] \"Protection sols grande hauteur\" ! C'EST INTERDIT !\n\nâœ… CORRECT : Tu affiches TOUTES les lignes, de [0] Ã  [length - 1]\n\n**RÃ¨gles importantes :**\n- Si body.travaux.length = 3, tu affiches EXACTEMENT 3 lignes (pas 2, pas 4)\n- Tu commences TOUJOURS par body.travaux[0] (ne saute JAMAIS la premiÃ¨re ligne, mÃªme si elle contient \"forfait\" ou \"Protection\")\n- Tu nettoies le label : enlÃ¨ve \"â€¢\", \"\\t\", les flÃ¨ches \"â†’\", les prix dans le label\n- Pour l'unitÃ© : si unit est null/vide et le label contient \"forfait\" â†’ utilise \"forfait\", sinon utilise l'unitÃ© fournie\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 2 : TU ATTENDS LA RÃ‰PONSE DE L'UTILISATEUR\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Tu attends que l'utilisateur rÃ©ponde Ã  tes questions\n2. **ðŸš¨ CRITIQUE :** Si l'utilisateur dit \"tout est correct\" ou \"c'est bon\" APRÃˆS le rÃ©sumÃ© initial, c'est juste une rÃ©ponse aux questions (mÃªme s'il ne rÃ©pond pas explicitement aux questions). TU NE CRÃ‰ES PAS le devis maintenant !\n3. Tu DOIS passer Ã  l'Ã‰TAPE 3 pour faire le rÃ©sumÃ© final et demander confirmation\n4. Tu NE CRÃ‰ES PAS le devis avant d'avoir fait le rÃ©sumÃ© final (Ã©tape 3) et reÃ§u la confirmation (Ã©tape 4)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 3 : TU FAIS UN NOUVEAU RÃ‰SUMÃ‰ FINAL AVEC LES RÃ‰PONSES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Combine le rÃ©sumÃ© initial + les rÃ©ponses reÃ§ues\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ FINAL - PRÃŠT POUR LA CRÃ‰ATION\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [nom depuis body.client.name OU historique]\nâ€¢ Email : [email depuis body.client.email OU historique]\nâ€¢ TÃ©lÃ©phone : [tÃ©lÃ©phone depuis body.client.phone OU historique]\nâ€¢ Adresse de facturation : [adresse depuis body.client.address OU historique]\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : [adresse confirmÃ©e depuis la rÃ©ponse]\nâ€¢ DÃ©lai d'exÃ©cution : [rÃ©ponse reÃ§ue, ex: \"20 jours\"]\nâ€¢ Notes : [rÃ©ponse reÃ§ue ou \"Aucune\"]\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nðŸš¨ VÃ‰RIFIE : Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes ci-dessous :\n\nâ€¢ [body.travaux[0].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT  â† COMMENCE PAR [0] !\nâ€¢ [body.travaux[1].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT\nâ€¢ [body.travaux[2].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES, DE 0 Ã€ body.travaux.length - 1, SANS EN SAUTER AUCUNE)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [montant] â‚¬\nâ€¢ TVA : [montant] â‚¬\nâ€¢ Total TTC : [montant] â‚¬\n\n---\n\nðŸš¨ OBLIGATOIRE : TU DOIS DEMANDER CONFIRMATION ICI !\n\nâœ… Est-ce correct ? Souhaitez-vous que je crÃ©e ce devis ?\n\nâš ï¸ CRITIQUE : \n- NE CRÃ‰E PAS AVANT D'AVOIR REÃ‡U UNE RÃ‰PONSE EXPLICITE \"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\", etc.\n- Si l'utilisateur dit \"tout est correct\" APRÃˆS le rÃ©sumÃ© initial (Ã©tape 1), ce n'est PAS une confirmation pour crÃ©er - c'est juste une rÃ©ponse. Tu passes Ã  l'Ã‰TAPE 3 (rÃ©sumÃ© final) et tu demandes confirmation.\n- Si l'utilisateur dit \"c'est bon\" APRÃˆS le rÃ©sumÃ© final (Ã©tape 3 - ici), ALORS c'est une confirmation et tu peux crÃ©er Ã  l'Ã‰TAPE 5.\n```\n\n**Exemple concret :**\nSi l'utilisateur rÃ©pond \"dÃ©lai de 20 jours et les adresse identique pas de note\", tu affiches :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ FINAL - PRÃŠT POUR LA CRÃ‰ATION\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : Claire Montoya\nâ€¢ Email : claire.montoya66@gmail.com\nâ€¢ TÃ©lÃ©phone : 0761843290\nâ€¢ Adresse de facturation : 6 rue du GÃ©nÃ©ral Leclerc, 66000 Perpignan\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : 6 rue du GÃ©nÃ©ral Leclerc, 66000 Perpignan (identique)\nâ€¢ DÃ©lai d'exÃ©cution : 20 jours\nâ€¢ Notes : Aucune\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\nâ€¢ Rebouchage trous et fissures - 33 mÂ² Ã— 19 â‚¬ HT\nâ€¢ Peinture murs blanc mat - 33 mÂ² Ã— 30 â‚¬ HT\n\nðŸ’° TOTAL\nâ€¢ Total HT : 2 027,00 â‚¬\nâ€¢ TVA : 243,70 â‚¬\nâ€¢ Total TTC : 2 270,70 â‚¬\n\n---\n\nâœ… Est-ce correct ? Souhaitez-vous que je crÃ©e ce devis ?\n```\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 4 : TU ATTENDS LA CONFIRMATION EXPLICITE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Tu attends que l'utilisateur confirme explicitement avec \"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\", etc.\n2. Si l'utilisateur dit juste \"oui c'est bon\" APRÃˆS avoir rÃ©pondu aux questions (avant ton rÃ©sumÃ© final), tu passes d'abord Ã  l'Ã‰TAPE 3 (faire le rÃ©sumÃ© final), puis tu demandes confirmation, puis tu attends\n3. Tu NE CRÃ‰ES PAS le devis tant que tu n'as pas reÃ§u cette confirmation explicite\n4. Une fois confirmÃ©, tu passes Ã  l'Ã‰TAPE 5\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 5 : TU CRÃ‰ES LE DEVIS (APRÃˆS CONFIRMATION)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**5.1. TU CHERCHES LE CLIENT**\n\n**ðŸš¨ IMPORTANT :** Tu DOIS chercher le client avec le nom EXACT du message initial !\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"search-client\",\n  \"payload\": {\n    \"query\": \"[nom complet depuis body.client.name OU historique - utilise le nom du premier message, pas celui d'un autre client]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**Exemple :** Si le message initial dit \"devis pour Mathieu Renaud, 4 impasse des Pins\", tu cherches \"Mathieu Renaud\", PAS un autre nom !\n\n**5.2. SI LE CLIENT N'EST PAS TROUVÃ‰, TU LE CRÃ‰ES**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"create-client\",\n  \"payload\": {\n    \"nom\": \"[dernier mot de body.client.name, ex: 'Montoya']\",\n    \"prenom\": \"[tous les mots sauf le dernier, ex: 'Claire']\",\n    \"email\": \"[email depuis body.client.email OU historique]\",\n    \"telephone\": \"[tÃ©lÃ©phone depuis body.client.phone OU historique]\",\n    \"adresse_facturation\": \"[adresse depuis body.client.address OU historique]\",\n    \"type\": \"particulier\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**5.3. TU CRÃ‰ES LE DEVIS**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"create-devis\",\n  \"payload\": {\n    \"client_id\": \"[UUID du client trouvÃ© ou crÃ©Ã©]\",\n    \"adresse_chantier\": \"[adresse confirmÃ©e]\",\n    \"delai_execution\": \"[dÃ©lai depuis la rÃ©ponse, ex: '20 jours']\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**IMPORTANT :** Tu DOIS conserver le UUID du devis depuis `data.devis.id` dans la rÃ©ponse !\n\n**5.4. TU AJOUTES LES LIGNES DE TRAVAUX**\n\n**VÃ‰RIFICATION CRITIQUE AVANT D'ENVOYER :**\n1. Compte le nombre d'Ã©lÃ©ments dans body.travaux : `body.travaux.length`\n   - Si body.travaux.length = 3 â†’ tu DOIS crÃ©er EXACTEMENT 3 lignes (pas 2, pas 4)\n2. CrÃ©e EXACTEMENT `body.travaux.length` lignes dans le tableau `lignes`\n3. VÃ©rifie que tu as inclus TOUTES les lignes de [0] Ã  [length - 1] :\n   - âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n   - âœ… J'ai inclus body.travaux[1] ?\n   - âœ… J'ai inclus body.travaux[2] ?\n   - âœ… ... jusqu'Ã  body.travaux[length - 1]\n4. **SI body.travaux.length = 3 mais tu n'as crÃ©Ã© que 2 lignes â†’ TU AS FAIT UNE ERREUR, recommence !**\n\n**RÃ¨gle pour dÃ©terminer l'unitÃ© :**\n- Si `body.travaux[i].unit` existe et n'est pas vide â†’ utilise cette valeur\n- Si `body.travaux[i].unit` est null/vide :\n  - Si le label contient \"forfait\" â†’ utilise \"forfait\"\n  - Si le label contient \"mÂ²\" ou \"m2\" â†’ utilise \"mÂ²\"\n  - Si le label contient \"ml\" â†’ utilise \"ml\"\n  - Sinon â†’ utilise \"u.\"\n\n**Exemple concret :**\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", quantity: 1, unit: null, unit_price: 680, tva: 20},  â† [0] - PREMIÃˆRE LIGNE\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 32, tva: 10},      â† [1]\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 44, tva: 10}     â† [2]\n]\n\nbody.travaux.length = 3, donc tu DOIS crÃ©er EXACTEMENT 3 lignes dans le tableau `lignes` :\n\n```json\n{\n  \"action\": \"add-ligne-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis]\",\n    \"lignes\": [\n      {  // â† LIGNE 1 : body.travaux[0] (OBLIGATOIRE !)\n        \"designation\": \"Protection sols grande hauteur\",\n        \"quantite\": 1,\n        \"unite\": \"forfait\",  // car unit est null et label contient \"forfait\"\n        \"prix_unitaire_ht\": 680,\n        \"tva_pct\": 20\n      },\n      {  // â† LIGNE 2 : body.travaux[1]\n        \"designation\": \"Enduit murs grande hauteur\",\n        \"quantite\": 82,\n        \"unite\": \"mÂ²\",  // car unit existe\n        \"prix_unitaire_ht\": 32,\n        \"tva_pct\": 10\n      },\n      {  // â† LIGNE 3 : body.travaux[2]\n        \"designation\": \"Peinture murs satin premium\",\n        \"quantite\": 82,\n        \"unite\": \"mÂ²\",  // car unit existe\n        \"prix_unitaire_ht\": 44,\n        \"tva_pct\": 10\n      }\n    ]  // â† Tu as crÃ©Ã© EXACTEMENT 3 lignes (lignes.length = 3 = body.travaux.length)\n  },\n  \"tenant_id\": \"[tenant_id]\"\n}\n```\n\n**ðŸš¨ ERREUR Ã€ Ã‰VITER :**\nâŒ NE PAS crÃ©er seulement 2 lignes en oubliant body.travaux[0] :\n```json\n\"lignes\": [\n  {  // body.travaux[1] seulement\n    \"designation\": \"Enduit murs grande hauteur\",\n    ...\n  },\n  {  // body.travaux[2] seulement\n    \"designation\": \"Peinture murs satin premium\",\n    ...\n  }\n  // âŒ MANQUE body.travaux[0] \"Protection sols grande hauteur\" !\n]\n```\nâ†’ C'EST INTERDIT ! Tu DOIS inclure TOUTES les lignes, de [0] Ã  [length - 1] !\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"add-ligne-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ© Ã  l'Ã©tape 5.3]\",\n    \"lignes\": [\n      {\n        \"designation\": \"[body.travaux[0].label nettoyÃ©, ex: 'Protection chantier']\",\n        \"quantite\": [body.travaux[0].quantity, ex: 1],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e selon les rÃ¨gles ci-dessus, ex: 'forfait']\",\n        \"prix_unitaire_ht\": [body.travaux[0].unit_price, ex: 410],\n        \"tva_pct\": [body.travaux[0].tva, ex: 20]\n      },\n      {\n        \"designation\": \"[body.travaux[1].label nettoyÃ©, ex: 'Rebouchage trous et fissures']\",\n        \"quantite\": [body.travaux[1].quantity, ex: 33],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e, ex: 'mÂ²']\",\n        \"prix_unitaire_ht\": [body.travaux[1].unit_price, ex: 19],\n        \"tva_pct\": [body.travaux[1].tva, ex: 10]\n      },\n      {\n        \"designation\": \"[body.travaux[2].label nettoyÃ©]\",\n        \"quantite\": [body.travaux[2].quantity],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e]\",\n        \"prix_unitaire_ht\": [body.travaux[2].unit_price],\n        \"tva_pct\": [body.travaux[2].tva]\n      }\n      ... (TU DOIS CRÃ‰ER UNE LIGNE POUR CHAQUE Ã‰LÃ‰MENT DE body.travaux, DE 0 Ã€ length - 1)\n    ]\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**Exemple concret :**\nSi body.travaux.length = 3, tu dois crÃ©er EXACTEMENT 3 lignes dans le tableau `lignes`.\n\n**5.5. TU FINALISES LE DEVIS**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"finalize-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ©]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**5.6. TU RÃ‰CUPÃˆRES LE DEVIS COMPLET**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"get-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ© Ã  l'Ã©tape 5.3]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**IMPORTANT :** Tu utilises l'UUID (pas le numÃ©ro) pour get-devis !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 6 : TU AFFICHES LE RÃ‰SUMÃ‰ FINAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Utilise les donnÃ©es de la rÃ©ponse de `get-devis` (Ã©tape 5.6)\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nâœ… DEVIS CRÃ‰Ã‰ AVEC SUCCÃˆS !\n\nðŸ“„ INFORMATIONS DU DEVIS\nâ€¢ NumÃ©ro : [data.devis.numero, ex: 'DV-2025-042']\nâ€¢ Date : [data.devis.date_creation]\nâ€¢ Statut : [data.devis.statut]\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [data.client.nom_complet OU nom + prenom]\nâ€¢ Email : [data.client.email]\nâ€¢ TÃ©lÃ©phone : [data.client.telephone]\n\nðŸ“ ADRESSES\nâ€¢ Facturation : [data.client.adresse_facturation]\nâ€¢ Chantier : [data.devis.adresse_chantier]\n\nðŸ”¨ DÃ‰TAIL DES TRAVAUX\nâ€¢ [data.lignes[0].designation] - [data.lignes[0].quantite] [data.lignes[0].unite] Ã— [data.lignes[0].prix_unitaire_ht] â‚¬ HT\nâ€¢ [data.lignes[1].designation] - [data.lignes[1].quantite] [data.lignes[1].unite] Ã— [data.lignes[1].prix_unitaire_ht] â‚¬ HT\nâ€¢ [data.lignes[2].designation] - [data.lignes[2].quantite] [data.lignes[2].unite] Ã— [data.lignes[2].prix_unitaire_ht] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [data.devis.montant_ht] â‚¬\nâ€¢ TVA : [data.devis.montant_tva] â‚¬\nâ€¢ Total TTC : [data.devis.montant_ttc] â‚¬\n\nðŸ“… CONDITIONS\nâ€¢ DÃ©lai d'exÃ©cution : [data.devis.delai_execution]\n\nðŸ”— Lien du devis : [data.devis.pdf_url]\n*(Vous pouvez cliquer sur ce lien pour visualiser ou tÃ©lÃ©charger le PDF du devis)*\n\n---\nðŸ”— Que souhaitez-vous faire maintenant ?\nâ€¢ Envoyer le devis par email\nâ€¢ CrÃ©er une facture d'acompte\nâ€¢ CrÃ©er un autre devis\n```\n\n**IMPORTANT :** Le champ `pdf_url` est OBLIGATOIRE dans le rÃ©sumÃ© final !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRÃˆGLES GÃ‰NÃ‰RALES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**1. Utilisation de l'historique de conversation :**\n- Si `body.client` est null/vide dans le message actuel â†’ tu DOIS utiliser les informations du premier message de l'historique\n- Si `body.travaux` est null/vide dans le message actuel â†’ tu DOIS utiliser les travaux du premier message de l'historique\n- Ne demande JAMAIS Ã  l'utilisateur des informations qui sont dÃ©jÃ  dans l'historique\n\n**ðŸš¨ IMPORTANT : Utilisation des bonnes informations client :**\n- Quand tu crÃ©es le devis, tu DOIS utiliser les informations du client que tu as trouvÃ©/crÃ©Ã© (Ã©tape 5.1 ou 5.2)\n- Dans le rÃ©sumÃ© final (Ã©tape 6), tu DOIS utiliser les donnÃ©es du devis que tu viens de crÃ©er (depuis get-devis)\n- NE JAMAIS utiliser les informations d'un autre client dans le rÃ©sumÃ© final\n- Si tu crÃ©es un devis pour \"Mathieu Renaud, 4 impasse des Pins\", mais que le rÃ©sumÃ© final affiche un autre nom/adresse â†’ TU AS FAIT UNE ERREUR !\n\n**2. Format call_edge_function :**\n```json\n{\n  \"action\": \"nom-de-l-action\",\n  \"payload\": {\n    // Tous les paramÃ¨tres (SANS tenant_id ici)\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id - OBLIGATOIRE au niveau racine]\"\n}\n```\n\n**IMPORTANT :** Le `tenant_id` doit Ãªtre au niveau racine, PAS dans le payload !\n\n**3. UUID vs NumÃ©ro :**\n- **get-devis/get-facture** : Tu DOIS utiliser un UUID (utilise `list-devis` si tu n'as que le numÃ©ro)\n- **creer-facture-depuis-devis** : Tu peux utiliser le numÃ©ro directement (ex: \"DV-2025-042\") OU l'UUID\n- **envoyer-devis/envoyer-facture** : Tu DOIS utiliser un UUID\n\n**4. AprÃ¨s create-devis :**\n- La rÃ©ponse contient `data.devis.id` (UUID) et `data.devis.numero`\n- Tu DOIS conserver l'UUID (`data.devis.id`) pour get-devis/envoyer-devis !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW CRÃ‰ATION FACTURE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND L'UTILISATEUR DEMANDE DE CRÃ‰ER UNE FACTURE :**\n\n1. Tu extrais le numÃ©ro du devis depuis la demande (ex: \"DV-2025-042\")\n2. Tu determines le type :\n   - Si l'utilisateur dit \"facture d'acompte\" â†’ type = \"acompte\"\n   - Si l'utilisateur dit \"facture intermÃ©diaire\" â†’ type = \"intermediaire\"\n   - Si l'utilisateur dit \"facture de solde\" â†’ type = \"solde\"\n   - Si l'utilisateur ne prÃ©cise pas â†’ type = \"acompte\" (par dÃ©faut)\n3. Tu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"creer-facture-depuis-devis\",\n  \"payload\": {\n    \"devis_id\": \"[numÃ©ro du devis, ex: 'DV-2025-042', OU UUID]\",\n    \"type\": \"[acompte/intermediaire/solde]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n4. Si erreur ALREADY_EXISTS : tu affiches les factures existantes et proposes le type suivant\n5. Tu rÃ©cupÃ¨res la facture avec get-facture (utilise l'UUID de la rÃ©ponse)\n6. Tu affiches le rÃ©sumÃ© final avec pdf_url (mÃªme format que pour le devis)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW ENVOI EMAIL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND L'UTILISATEUR DEMANDE D'ENVOYER UN DEVIS/FACTURE PAR EMAIL :**\n\n1. Tu appelles get-devis ou get-facture (avec UUID, PAS le numÃ©ro)\n2. Tu composes un message : sujet + corps de l'email\n3. Tu affiches un rÃ©sumÃ© avec : destinataire, sujet, message complet, lien PDF\n4. Tu demandes confirmation : \"Souhaitez-vous que j'envoie cet email ?\"\n5. Tu attends la rÃ©ponse\n6. Si \"Oui\" â†’ tu appelles envoyer-devis/envoyer-facture (avec UUID)\n7. Tu confirmes l'envoi\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCHECKLIST AVANT CHAQUE MESSAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**AprÃ¨s le rÃ©sumÃ© initial (Ã‰TAPE 1) :**\n1. âœ… J'ai affichÃ© TOUTES les lignes de travaux (si body.travaux.length = 3, j'affiche 3 lignes) ?\n2. âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n3. âœ… J'ai posÃ© les questions (dÃ©lai d'exÃ©cution, adresse chantier, notes) ?\n4. âœ… J'ai demandÃ© confirmation ? (NON - tu ne demandes pas confirmation aprÃ¨s le rÃ©sumÃ© initial, tu poses les questions !)\n\n**AprÃ¨s les rÃ©ponses de l'utilisateur (Ã‰TAPE 2) :**\n1. âœ… Si l'utilisateur dit \"tout est correct\", je comprends que c'est une rÃ©ponse (pas une confirmation) ?\n2. âœ… Je passe Ã  l'Ã‰TAPE 3 (rÃ©sumÃ© final) et je ne crÃ©e pas encore ?\n\n**AprÃ¨s le rÃ©sumÃ© final (Ã‰TAPE 3) :**\n1. âœ… J'ai affichÃ© TOUTES les lignes de travaux Ã  nouveau (si body.travaux.length = 3, j'affiche 3 lignes) ?\n2. âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n3. âœ… J'ai demandÃ© confirmation explicitement ?\n\n**Avant de crÃ©er (Ã‰TAPE 5) :**\n1. âœ… L'utilisateur a confirmÃ© explicitement (\"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\") APRÃˆS le rÃ©sumÃ© final ?\n2. âœ… J'ai bien posÃ© les questions et reÃ§u les rÃ©ponses avant de crÃ©er ?\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCHECKLIST AVANT CHAQUE APPEL call_edge_function\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. âœ… J'ai extrait tenant_id depuis body.context.tenant_id ?\n2. âœ… J'ai mis tenant_id au niveau racine (PAS dans payload) ?\n3. âœ… Pour add-ligne-devis : lignes.length = body.travaux.length ?\n4. âœ… J'ai inclus TOUTES les lignes de travaux (de 0 Ã  body.travaux.length - 1) ?\n   - âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne, ne JAMAIS oublier celle-ci) ?\n   - âœ… J'ai inclus body.travaux[1] ?\n   - âœ… ... jusqu'Ã  body.travaux[length - 1] ?\n5. âœ… Dans mes rÃ©sumÃ©s, j'ai affichÃ© TOUTES les lignes de body.travaux (si length = 3, j'affiche 3 lignes, pas 2) ?\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRÃˆGLES DE FORMAT AFFICHAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Pour les lignes de travaux dans les rÃ©sumÃ©s :**\n- Tu affiches UNIQUEMENT : dÃ©signation - quantitÃ© unitÃ© Ã— prix â‚¬ HT\n- Tu n'affiches PAS les dÃ©tails HT/TVA/TTC pour chaque ligne individuelle\n- Tu affiches les totaux UNE SEULE FOIS Ã  la fin\n\n**Exemple CORRECT :**\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\nâ€¢ Rebouchage trous et fissures - 33 mÂ² Ã— 19 â‚¬ HT\nâ€¢ Peinture murs blanc mat - 33 mÂ² Ã— 30 â‚¬ HT\n\nðŸ’° TOTAL\nâ€¢ Total HT : 2 027,00 â‚¬\nâ€¢ TVA : 243,70 â‚¬\nâ€¢ Total TTC : 2 270,70 â‚¬\n```\n\n**Exemple INCORRECT (trop verbeux) :**\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\n  - Total HT: 410,00 â‚¬\n  - TVA: 20% â†’ 82,00 â‚¬\n  - Total TTC: 492,00 â‚¬\n```\n",
          "temperature": 0.7
        },
        "tools": {
          "values": [
            {
              "name": "call_edge_function",
              "description": "Point d'entrÃ©e unique pour toutes les opÃ©rations CRUD de LÃ‰O via leo-router. L'IA doit gÃ©nÃ©rer un JSON avec: { \"action\": \"...\", \"payload\": {...}, \"tenant_id\": \"...\" }",
              "type": "httpRequest",
              "httpRequest": {
                "url": "https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1/leo-router",
                "method": "POST",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendHeaders": true,
                "headerParameters": {
                  "parameters": [
                    {
                      "name": "Authorization",
                      "value": "Bearer {{ $env.LEO_API_SECRET }}"
                    },
                    {
                      "name": "Content-Type",
                      "value": "application/json"
                    }
                  ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ JSON.stringify({ action: $json.action, payload: $json.payload, tenant_id: $json.tenant_id }) }}",
                "options": {}
              },
              "schema": {
                "type": "object",
                "properties": {
                  "action": {
                    "type": "string",
                    "description": "Action Ã  effectuer (ex: 'chercher-client', 'creer-client')"
                  },
                  "payload": {
                    "type": "object",
                    "description": "ParamÃ¨tres de l'action"
                  },
                  "tenant_id": {
                    "type": "string",
                    "description": "UUID du tenant depuis context.tenant_id"
                  }
                },
                "required": [
                  "action",
                  "payload",
                  "tenant_id"
                ]
              }
            }
          ]
        }
      },
      "id": "ai-agent-leo",
      "name": "AI Agent LÃ‰O",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.3,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format response pour l'utilisateur\nconst input = $input.item.json;\n\n// Extraire la rÃ©ponse de l'AI\nconst response = input.output || input.text || input.message || \"\";\n\nreturn {\n  message: response,\n  success: true\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.context.is_whatsapp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-response-type",
      "name": "Check Response Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "to": "={{ $json.context.phone || $json.body.phone }}",
        "message": "={{ $json.message }}",
        "options": {}
      },
      "id": "send-sms",
      "name": "Send SMS/WhatsApp",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        1850,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.message }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1850,
        400
      ]
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "Check Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Message Type": {
      "main": [
        [
          {
            "node": "Format Text Message for LEO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Audio Message for LEO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Text Message for LEO": {
      "main": [
        [
          {
            "node": "Merge Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Audio Message for LEO": {
      "main": [
        [
          {
            "node": "Merge Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Messages": {
      "main": [
        [
          {
            "node": "Extract Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Info": {
      "main": [
        [
          {
            "node": "AI Agent LÃ‰O",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent LÃ‰O": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Check Response Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Response Type": {
      "main": [
        [
          {
            "node": "Send SMS/WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-20T12:00:00.000Z",
  "versionId": "1"
}
  "nodes": [
    {
      "parameters": {},
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "type": "n8n-nodes-base.chatTrigger",
      "typeVersion": 1,
      "position": [
        250,
        300
      ],
      "webhookId": "leo-chat-trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-message-type",
      "name": "Check Message Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format message pour LÃ‰O\nconst input = $input.item.json;\n\nreturn {\n  body: {\n    raw_message: input.body?.message || input.body?.text || \"\",\n    client: input.body?.client || null,\n    travaux: input.body?.travaux || null\n  },\n  context: {\n    tenant_id: input.context?.tenant_id || input.body?.tenant_id || \"\",\n    conversation_date: new Date().toISOString().split('T')[0],\n    is_whatsapp: input.context?.is_whatsapp || false\n  }\n};"
      },
      "id": "format-text-message",
      "name": "Format Text Message for LEO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format message audio pour LÃ‰O\nconst input = $input.item.json;\n\nreturn {\n  body: {\n    raw_message: input.body?.transcription || input.body?.message || \"\",\n    client: input.body?.client || null,\n    travaux: input.body?.travaux || null\n  },\n  context: {\n    tenant_id: input.context?.tenant_id || input.body?.tenant_id || \"\",\n    conversation_date: new Date().toISOString().split('T')[0],\n    is_whatsapp: input.context?.is_whatsapp || false\n  }\n};"
      },
      "id": "format-audio-message",
      "name": "Format Audio Message for LEO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        400
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge-messages",
      "name": "Merge Messages",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parser les travaux depuis raw_message et extraire informations\nconst input = $input.item.json;\nconst rawMessage = input.body?.raw_message || \"\";\n\n// Si travaux dÃ©jÃ  prÃ©sents, les utiliser\nif (input.body?.travaux && Array.isArray(input.body.travaux) && input.body.travaux.length > 0) {\n  return {\n    ...input,\n    extracted_info: {\n      has_client_info: !!input.body?.client,\n      has_travaux: true,\n      travaux_count: input.body.travaux.length,\n      message_length: rawMessage.length\n    }\n  };\n}\n\n// Sinon, parser depuis raw_message\nconst travaux = [];\nconst lines = rawMessage.split('\\n');\n\nfor (const line of lines) {\n  const trimmed = line.trim();\n  \n  // Ignorer les lignes vides ou trop courtes\n  if (!trimmed || trimmed.length < 5) continue;\n  \n  // Identifier les lignes de travaux (commencent par â€¢, -, *, ou numÃ©ro)\n  const isTravauxLine = /^[â€¢\\-\\*]\\s+/.test(trimmed) || /^\\d+[\\.\\)]\\s+/.test(trimmed);\n  \n  if (isTravauxLine) {\n    // Nettoyer la ligne\n    let clean = trimmed.replace(/^[â€¢\\-\\*]\\s+/, '').replace(/^\\d+[\\.\\)]\\s+/, '');\n    \n    // Extraire dÃ©signation (avant â†’ ou â€”)\n    const separatorIndex = Math.max(clean.indexOf('â†’'), clean.indexOf('â€”'));\n    const designation = separatorIndex > 0 \n      ? clean.substring(0, separatorIndex).trim()\n      : clean.split(/[Ã—â‚¬]/)[0].trim();\n    \n    // Extraire TVA (par dÃ©faut 20%)\n    let tva = 20;\n    const tvaMatch = clean.match(/TVA\\s+(\\d+)\\%|â€”\\s*TVA\\s+(\\d+)\\%/i);\n    if (tvaMatch) {\n      tva = parseInt(tvaMatch[1] || tvaMatch[2]);\n    }\n    \n    // Extraire prix unitaire, quantitÃ© et unitÃ©\n    let unitPrice = 0;\n    let quantity = 1;\n    let unit = 'u.';\n    \n    // Chercher \"forfait\"\n    if (clean.toLowerCase().includes('forfait')) {\n      unit = 'forfait';\n      const prixMatch = clean.match(/([\\d\\s,]+)\\s*â‚¬/);\n      if (prixMatch) {\n        unitPrice = parseFloat(prixMatch[1].replace(/\\s/g, '').replace(',', '.'));\n      }\n    } else {\n      // Chercher \"quantitÃ© unitÃ© Ã— prix\"\n      const qtyPriceMatch = clean.match(/([\\d,\\.]+)\\s*(mÂ²|ml|m|u\\.|unitÃ©)\\s*Ã—\\s*([\\d\\s,]+)\\s*â‚¬/);\n      if (qtyPriceMatch) {\n        quantity = parseFloat(qtyPriceMatch[1].replace(',', '.'));\n        unit = qtyPriceMatch[2];\n        unitPrice = parseFloat(qtyPriceMatch[3].replace(/\\s/g, '').replace(',', '.'));\n      } else {\n        // Chercher juste le prix\n        const prixMatch = clean.match(/([\\d\\s,]+)\\s*â‚¬/);\n        if (prixMatch) {\n          unitPrice = parseFloat(prixMatch[1].replace(/\\s/g, '').replace(',', '.'));\n        }\n      }\n    }\n    \n    // Ajouter seulement si on a au moins une dÃ©signation et un prix\n    if (designation && unitPrice > 0) {\n      travaux.push({\n        label: designation,\n        quantity: quantity,\n        unit: unit,\n        unit_price: unitPrice,\n        tva: tva\n      });\n    }\n  }\n}\n\n// Retourner avec travaux parsÃ©s\nreturn {\n  ...input,\n  body: {\n    ...input.body,\n    travaux: travaux.length > 0 ? travaux : null\n  },\n  extracted_info: {\n    has_client_info: !!input.body?.client,\n    has_travaux: travaux.length > 0,\n    travaux_count: travaux.length,\n    message_length: rawMessage.length,\n    parsed_from_message: travaux.length > 0 && !input.body?.travaux\n  }\n};"
      },
      "id": "extract-info",
      "name": "Extract Info & Parse Travaux",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "agent": "openAi",
        "model": "gpt-4o",
        "options": {
          "systemMessage": "Tu es LÃ‰O, assistant IA pour le BTP.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ðŸš¨ðŸš¨ðŸš¨ RÃˆGLE ABSOLUE - LIRE EN PREMIER ðŸš¨ðŸš¨ðŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND TU AFFICHES LES TRAVAUX (dans les rÃ©sumÃ©s) :**\n- Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes\n- Tu DOIS TOUJOURS commencer par body.travaux[0] (la PREMIÃˆRE ligne)\n- Tu DOIS TOUJOURS continuer avec body.travaux[1], body.travaux[2], etc.\n- **NE JAMAIS SAUTER body.travaux[0] !**\n\n**EXEMPLE :**\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", ...},  â† [0] - NE JAMAIS OUBLIER !\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", ...},      â† [1]\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", ...}      â† [2]\n]\nâ†’ Tu DOIS afficher les 3 lignes, en commenÃ§ant par [0]\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ðŸ“‹ WORKFLOW EXACT - SUIVRE Ã‰TAPE PAR Ã‰TAPE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQUAND TU REÃ‡OIS UNE DEMANDE DE DEVIS, TU DOIS SUIVRE CES Ã‰TAPES DANS L'ORDRE STRICT :\n\n**ðŸš¨ INTERDICTIONS ABSOLUES :**\n- âŒ TU NE DOIS PAS demander confirmation aprÃ¨s le rÃ©sumÃ© initial (Ã©tape 1)\n- âŒ TU NE DOIS PAS crÃ©er le devis si tu n'as pas posÃ© les questions et reÃ§u les rÃ©ponses\n- âŒ TU NE DOIS PAS crÃ©er le devis si l'utilisateur dit \"tout est correct\" APRÃˆS le rÃ©sumÃ© initial (c'est juste une rÃ©ponse, pas une confirmation pour crÃ©er)\n- âŒ TU NE DOIS PAS crÃ©er le devis avant d'avoir fait le rÃ©sumÃ© final (Ã©tape 3) et demandÃ© confirmation (Ã©tape 4)\n\n**âœ… ORDRE OBLIGATOIRE :**\n1. RÃ©sumÃ© initial (Ã©tape 1)\n2. Poser les questions (Ã©tape 1 - dans le mÃªme message)\n3. Attendre les rÃ©ponses (Ã©tape 2)\n4. RÃ©sumÃ© final avec les rÃ©ponses (Ã©tape 3)\n5. Demander confirmation (Ã©tape 3 - dans le mÃªme message)\n6. Attendre confirmation (Ã©tape 4)\n7. CrÃ©er le devis (Ã©tape 5)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 1 : TU DOIS FAIRE UN RÃ‰SUMÃ‰ COMPLET IMMÃ‰DIATEMENT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. RÃ©cupÃ¨re les informations depuis body.client et body.travaux (ou depuis l'historique si body.client est null/vide)\n\n**ðŸš¨ VÃ‰RIFICATION CRITIQUE AVANT D'AFFICHER LE RÃ‰SUMÃ‰ :**\n- Compte le nombre d'Ã©lÃ©ments dans body.travaux : `body.travaux.length`\n- Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes (pas 2, pas 4, EXACTEMENT 3)\n- Tu DOIS commencer par body.travaux[0] (la PREMIÃˆRE ligne, ne saute JAMAIS celle-ci)\n- Tu DOIS continuer avec body.travaux[1], puis body.travaux[2], etc. jusqu'Ã  body.travaux[length - 1]\n- **Si tu vois 3 travaux dans body.travaux mais tu n'en affiches que 2, tu as FAIT UNE ERREUR - recommence !**\n\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ DE VOTRE DEMANDE\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [nom depuis body.client.name OU historique]\nâ€¢ Email : [email depuis body.client.email OU historique]\nâ€¢ TÃ©lÃ©phone : [tÃ©lÃ©phone depuis body.client.phone OU historique]\nâ€¢ Adresse de facturation : [adresse depuis body.client.address OU historique]\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : [adresse depuis body.client.address OU historique] (Ã  confirmer si identique)\nâ€¢ DÃ©lai d'exÃ©cution : Ã€ PRÃ‰CISER\nâ€¢ Notes : Aucune pour l'instant\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nðŸš¨ VÃ‰RIFIE : Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes ci-dessous :\n\nâ€¢ [body.travaux[0].label nettoyÃ©] - [body.travaux[0].quantity] [body.travaux[0].unit] Ã— [body.travaux[0].unit_price] â‚¬ HT  â† COMMENCE PAR [0] !\nâ€¢ [body.travaux[1].label nettoyÃ©] - [body.travaux[1].quantity] [body.travaux[1].unit] Ã— [body.travaux[1].unit_price] â‚¬ HT\nâ€¢ [body.travaux[2].label nettoyÃ©] - [body.travaux[2].quantity] [body.travaux[2].unit] Ã— [body.travaux[2].unit_price] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES, DE 0 Ã€ body.travaux.length - 1, SANS EN SAUTER AUCUNE)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [CALCULE la somme de tous les quantity Ã— unit_price] â‚¬\nâ€¢ TVA : [CALCULE la TVA sur chaque ligne et additionne] â‚¬\nâ€¢ Total TTC : [CALCULE Total HT + TVA] â‚¬\n\n---\n\nðŸš¨ OBLIGATOIRE : TU DOIS TOUJOURS POSER CES QUESTIONS APRÃˆS LE RÃ‰SUMÃ‰ INITIAL !\n\nâ“ AVANT DE CRÃ‰ER, J'AURAIS BESOIN DE QUELQUES PRÃ‰CISIONS :\n\n1ï¸âƒ£ DÃ©lai d'exÃ©cution : D'ici combien de temps dÃ©marrez-vous ce chantier ?\n\n2ï¸âƒ£ Adresse chantier : L'adresse [ADRESSE] est-elle identique pour la facturation et le chantier ?\n\n3ï¸âƒ£ Notes (optionnel) : Avez-vous des remarques Ã  ajouter ?\n\nRÃ©pondez simplement Ã  ces questions et je finaliserai votre devis ! ðŸ“‹\n\nâš ï¸ NE DEMANDE PAS DE CONFIRMATION ICI ! Tu dois d'abord poser ces questions et attendre les rÃ©ponses.\n```\n\n**Exemple concret de ce que tu dois afficher pour les travaux :**\n\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", quantity: 1, unit: null, unit_price: 680, tva: 20},\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 32, tva: 10},\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 44, tva: 10}\n]\n\n**body.travaux.length = 3, donc tu DOIS afficher EXACTEMENT 3 lignes, en commenÃ§ant par body.travaux[0] :**\n\nTu dois afficher EXACTEMENT :\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection sols grande hauteur - 1 forfait Ã— 680 â‚¬ HT  â† body.travaux[0] (OBLIGATOIRE !)\nâ€¢ Enduit murs grande hauteur - 82 mÂ² Ã— 32 â‚¬ HT          â† body.travaux[1]\nâ€¢ Peinture murs satin premium - 82 mÂ² Ã— 44 â‚¬ HT         â† body.travaux[2]\n\nðŸ’° TOTAL\nâ€¢ Total HT : 7 248,00 â‚¬\nâ€¢ TVA : 724,80 â‚¬\nâ€¢ Total TTC : 7 972,80 â‚¬\n```\n\n**ðŸš¨ ERREUR FRÃ‰QUENTE Ã€ Ã‰VITER :**\nâŒ NE PAS afficher seulement :\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Enduit murs grande hauteur - 82 mÂ² Ã— 32 â‚¬ HT\nâ€¢ Peinture murs satin premium - 82 mÂ² Ã— 44 â‚¬ HT\n```\nâ†’ Tu as oubliÃ© body.travaux[0] \"Protection sols grande hauteur\" ! C'EST INTERDIT !\n\nâœ… CORRECT : Tu affiches TOUTES les lignes, de [0] Ã  [length - 1]\n\n**RÃ¨gles importantes :**\n- Si body.travaux.length = 3, tu affiches EXACTEMENT 3 lignes (pas 2, pas 4)\n- Tu commences TOUJOURS par body.travaux[0] (ne saute JAMAIS la premiÃ¨re ligne, mÃªme si elle contient \"forfait\" ou \"Protection\")\n- Tu nettoies le label : enlÃ¨ve \"â€¢\", \"\\t\", les flÃ¨ches \"â†’\", les prix dans le label\n- Pour l'unitÃ© : si unit est null/vide et le label contient \"forfait\" â†’ utilise \"forfait\", sinon utilise l'unitÃ© fournie\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 2 : TU ATTENDS LA RÃ‰PONSE DE L'UTILISATEUR\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Tu attends que l'utilisateur rÃ©ponde Ã  tes questions\n2. **ðŸš¨ CRITIQUE :** Si l'utilisateur dit \"tout est correct\" ou \"c'est bon\" APRÃˆS le rÃ©sumÃ© initial, c'est juste une rÃ©ponse aux questions (mÃªme s'il ne rÃ©pond pas explicitement aux questions). TU NE CRÃ‰ES PAS le devis maintenant !\n3. Tu DOIS passer Ã  l'Ã‰TAPE 3 pour faire le rÃ©sumÃ© final et demander confirmation\n4. Tu NE CRÃ‰ES PAS le devis avant d'avoir fait le rÃ©sumÃ© final (Ã©tape 3) et reÃ§u la confirmation (Ã©tape 4)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 3 : TU FAIS UN NOUVEAU RÃ‰SUMÃ‰ FINAL AVEC LES RÃ‰PONSES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Combine le rÃ©sumÃ© initial + les rÃ©ponses reÃ§ues\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ FINAL - PRÃŠT POUR LA CRÃ‰ATION\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [nom depuis body.client.name OU historique]\nâ€¢ Email : [email depuis body.client.email OU historique]\nâ€¢ TÃ©lÃ©phone : [tÃ©lÃ©phone depuis body.client.phone OU historique]\nâ€¢ Adresse de facturation : [adresse depuis body.client.address OU historique]\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : [adresse confirmÃ©e depuis la rÃ©ponse]\nâ€¢ DÃ©lai d'exÃ©cution : [rÃ©ponse reÃ§ue, ex: \"20 jours\"]\nâ€¢ Notes : [rÃ©ponse reÃ§ue ou \"Aucune\"]\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nðŸš¨ VÃ‰RIFIE : Si body.travaux.length = 3, tu DOIS afficher EXACTEMENT 3 lignes ci-dessous :\n\nâ€¢ [body.travaux[0].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT  â† COMMENCE PAR [0] !\nâ€¢ [body.travaux[1].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT\nâ€¢ [body.travaux[2].label nettoyÃ©] - [quantity] [unit] Ã— [prix] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES, DE 0 Ã€ body.travaux.length - 1, SANS EN SAUTER AUCUNE)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [montant] â‚¬\nâ€¢ TVA : [montant] â‚¬\nâ€¢ Total TTC : [montant] â‚¬\n\n---\n\nðŸš¨ OBLIGATOIRE : TU DOIS DEMANDER CONFIRMATION ICI !\n\nâœ… Est-ce correct ? Souhaitez-vous que je crÃ©e ce devis ?\n\nâš ï¸ CRITIQUE : \n- NE CRÃ‰E PAS AVANT D'AVOIR REÃ‡U UNE RÃ‰PONSE EXPLICITE \"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\", etc.\n- Si l'utilisateur dit \"tout est correct\" APRÃˆS le rÃ©sumÃ© initial (Ã©tape 1), ce n'est PAS une confirmation pour crÃ©er - c'est juste une rÃ©ponse. Tu passes Ã  l'Ã‰TAPE 3 (rÃ©sumÃ© final) et tu demandes confirmation.\n- Si l'utilisateur dit \"c'est bon\" APRÃˆS le rÃ©sumÃ© final (Ã©tape 3 - ici), ALORS c'est une confirmation et tu peux crÃ©er Ã  l'Ã‰TAPE 5.\n```\n\n**Exemple concret :**\nSi l'utilisateur rÃ©pond \"dÃ©lai de 20 jours et les adresse identique pas de note\", tu affiches :\n\n```\nðŸ“‹ RÃ‰SUMÃ‰ FINAL - PRÃŠT POUR LA CRÃ‰ATION\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : Claire Montoya\nâ€¢ Email : claire.montoya66@gmail.com\nâ€¢ TÃ©lÃ©phone : 0761843290\nâ€¢ Adresse de facturation : 6 rue du GÃ©nÃ©ral Leclerc, 66000 Perpignan\n\nðŸ“„ DEVIS\nâ€¢ Adresse du chantier : 6 rue du GÃ©nÃ©ral Leclerc, 66000 Perpignan (identique)\nâ€¢ DÃ©lai d'exÃ©cution : 20 jours\nâ€¢ Notes : Aucune\n\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\nâ€¢ Rebouchage trous et fissures - 33 mÂ² Ã— 19 â‚¬ HT\nâ€¢ Peinture murs blanc mat - 33 mÂ² Ã— 30 â‚¬ HT\n\nðŸ’° TOTAL\nâ€¢ Total HT : 2 027,00 â‚¬\nâ€¢ TVA : 243,70 â‚¬\nâ€¢ Total TTC : 2 270,70 â‚¬\n\n---\n\nâœ… Est-ce correct ? Souhaitez-vous que je crÃ©e ce devis ?\n```\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 4 : TU ATTENDS LA CONFIRMATION EXPLICITE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Tu attends que l'utilisateur confirme explicitement avec \"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\", etc.\n2. Si l'utilisateur dit juste \"oui c'est bon\" APRÃˆS avoir rÃ©pondu aux questions (avant ton rÃ©sumÃ© final), tu passes d'abord Ã  l'Ã‰TAPE 3 (faire le rÃ©sumÃ© final), puis tu demandes confirmation, puis tu attends\n3. Tu NE CRÃ‰ES PAS le devis tant que tu n'as pas reÃ§u cette confirmation explicite\n4. Une fois confirmÃ©, tu passes Ã  l'Ã‰TAPE 5\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 5 : TU CRÃ‰ES LE DEVIS (APRÃˆS CONFIRMATION)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**5.1. TU CHERCHES LE CLIENT**\n\n**ðŸš¨ IMPORTANT :** Tu DOIS chercher le client avec le nom EXACT du message initial !\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"search-client\",\n  \"payload\": {\n    \"query\": \"[nom complet depuis body.client.name OU historique - utilise le nom du premier message, pas celui d'un autre client]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**Exemple :** Si le message initial dit \"devis pour Mathieu Renaud, 4 impasse des Pins\", tu cherches \"Mathieu Renaud\", PAS un autre nom !\n\n**5.2. SI LE CLIENT N'EST PAS TROUVÃ‰, TU LE CRÃ‰ES**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"create-client\",\n  \"payload\": {\n    \"nom\": \"[dernier mot de body.client.name, ex: 'Montoya']\",\n    \"prenom\": \"[tous les mots sauf le dernier, ex: 'Claire']\",\n    \"email\": \"[email depuis body.client.email OU historique]\",\n    \"telephone\": \"[tÃ©lÃ©phone depuis body.client.phone OU historique]\",\n    \"adresse_facturation\": \"[adresse depuis body.client.address OU historique]\",\n    \"type\": \"particulier\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**5.3. TU CRÃ‰ES LE DEVIS**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"create-devis\",\n  \"payload\": {\n    \"client_id\": \"[UUID du client trouvÃ© ou crÃ©Ã©]\",\n    \"adresse_chantier\": \"[adresse confirmÃ©e]\",\n    \"delai_execution\": \"[dÃ©lai depuis la rÃ©ponse, ex: '20 jours']\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**IMPORTANT :** Tu DOIS conserver le UUID du devis depuis `data.devis.id` dans la rÃ©ponse !\n\n**5.4. TU AJOUTES LES LIGNES DE TRAVAUX**\n\n**VÃ‰RIFICATION CRITIQUE AVANT D'ENVOYER :**\n1. Compte le nombre d'Ã©lÃ©ments dans body.travaux : `body.travaux.length`\n   - Si body.travaux.length = 3 â†’ tu DOIS crÃ©er EXACTEMENT 3 lignes (pas 2, pas 4)\n2. CrÃ©e EXACTEMENT `body.travaux.length` lignes dans le tableau `lignes`\n3. VÃ©rifie que tu as inclus TOUTES les lignes de [0] Ã  [length - 1] :\n   - âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n   - âœ… J'ai inclus body.travaux[1] ?\n   - âœ… J'ai inclus body.travaux[2] ?\n   - âœ… ... jusqu'Ã  body.travaux[length - 1]\n4. **SI body.travaux.length = 3 mais tu n'as crÃ©Ã© que 2 lignes â†’ TU AS FAIT UNE ERREUR, recommence !**\n\n**RÃ¨gle pour dÃ©terminer l'unitÃ© :**\n- Si `body.travaux[i].unit` existe et n'est pas vide â†’ utilise cette valeur\n- Si `body.travaux[i].unit` est null/vide :\n  - Si le label contient \"forfait\" â†’ utilise \"forfait\"\n  - Si le label contient \"mÂ²\" ou \"m2\" â†’ utilise \"mÂ²\"\n  - Si le label contient \"ml\" â†’ utilise \"ml\"\n  - Sinon â†’ utilise \"u.\"\n\n**Exemple concret :**\nSi body.travaux = [\n  {label: \"Protection sols grande hauteur â†’ forfait 680 â‚¬\", quantity: 1, unit: null, unit_price: 680, tva: 20},  â† [0] - PREMIÃˆRE LIGNE\n  {label: \"Enduit murs grande hauteur â†’ 82 mÂ² Ã— 32 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 32, tva: 10},      â† [1]\n  {label: \"Peinture murs satin premium â†’ 82 mÂ² Ã— 44 â‚¬\", quantity: 82, unit: \"mÂ²\", unit_price: 44, tva: 10}     â† [2]\n]\n\nbody.travaux.length = 3, donc tu DOIS crÃ©er EXACTEMENT 3 lignes dans le tableau `lignes` :\n\n```json\n{\n  \"action\": \"add-ligne-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis]\",\n    \"lignes\": [\n      {  // â† LIGNE 1 : body.travaux[0] (OBLIGATOIRE !)\n        \"designation\": \"Protection sols grande hauteur\",\n        \"quantite\": 1,\n        \"unite\": \"forfait\",  // car unit est null et label contient \"forfait\"\n        \"prix_unitaire_ht\": 680,\n        \"tva_pct\": 20\n      },\n      {  // â† LIGNE 2 : body.travaux[1]\n        \"designation\": \"Enduit murs grande hauteur\",\n        \"quantite\": 82,\n        \"unite\": \"mÂ²\",  // car unit existe\n        \"prix_unitaire_ht\": 32,\n        \"tva_pct\": 10\n      },\n      {  // â† LIGNE 3 : body.travaux[2]\n        \"designation\": \"Peinture murs satin premium\",\n        \"quantite\": 82,\n        \"unite\": \"mÂ²\",  // car unit existe\n        \"prix_unitaire_ht\": 44,\n        \"tva_pct\": 10\n      }\n    ]  // â† Tu as crÃ©Ã© EXACTEMENT 3 lignes (lignes.length = 3 = body.travaux.length)\n  },\n  \"tenant_id\": \"[tenant_id]\"\n}\n```\n\n**ðŸš¨ ERREUR Ã€ Ã‰VITER :**\nâŒ NE PAS crÃ©er seulement 2 lignes en oubliant body.travaux[0] :\n```json\n\"lignes\": [\n  {  // body.travaux[1] seulement\n    \"designation\": \"Enduit murs grande hauteur\",\n    ...\n  },\n  {  // body.travaux[2] seulement\n    \"designation\": \"Peinture murs satin premium\",\n    ...\n  }\n  // âŒ MANQUE body.travaux[0] \"Protection sols grande hauteur\" !\n]\n```\nâ†’ C'EST INTERDIT ! Tu DOIS inclure TOUTES les lignes, de [0] Ã  [length - 1] !\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"add-ligne-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ© Ã  l'Ã©tape 5.3]\",\n    \"lignes\": [\n      {\n        \"designation\": \"[body.travaux[0].label nettoyÃ©, ex: 'Protection chantier']\",\n        \"quantite\": [body.travaux[0].quantity, ex: 1],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e selon les rÃ¨gles ci-dessus, ex: 'forfait']\",\n        \"prix_unitaire_ht\": [body.travaux[0].unit_price, ex: 410],\n        \"tva_pct\": [body.travaux[0].tva, ex: 20]\n      },\n      {\n        \"designation\": \"[body.travaux[1].label nettoyÃ©, ex: 'Rebouchage trous et fissures']\",\n        \"quantite\": [body.travaux[1].quantity, ex: 33],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e, ex: 'mÂ²']\",\n        \"prix_unitaire_ht\": [body.travaux[1].unit_price, ex: 19],\n        \"tva_pct\": [body.travaux[1].tva, ex: 10]\n      },\n      {\n        \"designation\": \"[body.travaux[2].label nettoyÃ©]\",\n        \"quantite\": [body.travaux[2].quantity],\n        \"unite\": \"[unitÃ© dÃ©terminÃ©e]\",\n        \"prix_unitaire_ht\": [body.travaux[2].unit_price],\n        \"tva_pct\": [body.travaux[2].tva]\n      }\n      ... (TU DOIS CRÃ‰ER UNE LIGNE POUR CHAQUE Ã‰LÃ‰MENT DE body.travaux, DE 0 Ã€ length - 1)\n    ]\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**Exemple concret :**\nSi body.travaux.length = 3, tu dois crÃ©er EXACTEMENT 3 lignes dans le tableau `lignes`.\n\n**5.5. TU FINALISES LE DEVIS**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"finalize-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ©]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**5.6. TU RÃ‰CUPÃˆRES LE DEVIS COMPLET**\n\nTu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"get-devis\",\n  \"payload\": {\n    \"devis_id\": \"[UUID du devis conservÃ© Ã  l'Ã©tape 5.3]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n\n**IMPORTANT :** Tu utilises l'UUID (pas le numÃ©ro) pour get-devis !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰TAPE 6 : TU AFFICHES LE RÃ‰SUMÃ‰ FINAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Ce que tu dois faire :**\n1. Utilise les donnÃ©es de la rÃ©ponse de `get-devis` (Ã©tape 5.6)\n2. Affiche le rÃ©sumÃ© suivant avec EXACTEMENT ce format :\n\n```\nâœ… DEVIS CRÃ‰Ã‰ AVEC SUCCÃˆS !\n\nðŸ“„ INFORMATIONS DU DEVIS\nâ€¢ NumÃ©ro : [data.devis.numero, ex: 'DV-2025-042']\nâ€¢ Date : [data.devis.date_creation]\nâ€¢ Statut : [data.devis.statut]\n\nðŸ‘¤ CLIENT\nâ€¢ Nom : [data.client.nom_complet OU nom + prenom]\nâ€¢ Email : [data.client.email]\nâ€¢ TÃ©lÃ©phone : [data.client.telephone]\n\nðŸ“ ADRESSES\nâ€¢ Facturation : [data.client.adresse_facturation]\nâ€¢ Chantier : [data.devis.adresse_chantier]\n\nðŸ”¨ DÃ‰TAIL DES TRAVAUX\nâ€¢ [data.lignes[0].designation] - [data.lignes[0].quantite] [data.lignes[0].unite] Ã— [data.lignes[0].prix_unitaire_ht] â‚¬ HT\nâ€¢ [data.lignes[1].designation] - [data.lignes[1].quantite] [data.lignes[1].unite] Ã— [data.lignes[1].prix_unitaire_ht] â‚¬ HT\nâ€¢ [data.lignes[2].designation] - [data.lignes[2].quantite] [data.lignes[2].unite] Ã— [data.lignes[2].prix_unitaire_ht] â‚¬ HT\n... (TU DOIS AFFICHER TOUTES LES LIGNES)\n\nðŸ’° TOTAL\nâ€¢ Total HT : [data.devis.montant_ht] â‚¬\nâ€¢ TVA : [data.devis.montant_tva] â‚¬\nâ€¢ Total TTC : [data.devis.montant_ttc] â‚¬\n\nðŸ“… CONDITIONS\nâ€¢ DÃ©lai d'exÃ©cution : [data.devis.delai_execution]\n\nðŸ”— Lien du devis : [data.devis.pdf_url]\n*(Vous pouvez cliquer sur ce lien pour visualiser ou tÃ©lÃ©charger le PDF du devis)*\n\n---\nðŸ”— Que souhaitez-vous faire maintenant ?\nâ€¢ Envoyer le devis par email\nâ€¢ CrÃ©er une facture d'acompte\nâ€¢ CrÃ©er un autre devis\n```\n\n**IMPORTANT :** Le champ `pdf_url` est OBLIGATOIRE dans le rÃ©sumÃ© final !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRÃˆGLES GÃ‰NÃ‰RALES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**1. Utilisation de l'historique de conversation :**\n- Si `body.client` est null/vide dans le message actuel â†’ tu DOIS utiliser les informations du premier message de l'historique\n- Si `body.travaux` est null/vide dans le message actuel â†’ tu DOIS utiliser les travaux du premier message de l'historique\n- Ne demande JAMAIS Ã  l'utilisateur des informations qui sont dÃ©jÃ  dans l'historique\n\n**ðŸš¨ IMPORTANT : Utilisation des bonnes informations client :**\n- Quand tu crÃ©es le devis, tu DOIS utiliser les informations du client que tu as trouvÃ©/crÃ©Ã© (Ã©tape 5.1 ou 5.2)\n- Dans le rÃ©sumÃ© final (Ã©tape 6), tu DOIS utiliser les donnÃ©es du devis que tu viens de crÃ©er (depuis get-devis)\n- NE JAMAIS utiliser les informations d'un autre client dans le rÃ©sumÃ© final\n- Si tu crÃ©es un devis pour \"Mathieu Renaud, 4 impasse des Pins\", mais que le rÃ©sumÃ© final affiche un autre nom/adresse â†’ TU AS FAIT UNE ERREUR !\n\n**2. Format call_edge_function :**\n```json\n{\n  \"action\": \"nom-de-l-action\",\n  \"payload\": {\n    // Tous les paramÃ¨tres (SANS tenant_id ici)\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id - OBLIGATOIRE au niveau racine]\"\n}\n```\n\n**IMPORTANT :** Le `tenant_id` doit Ãªtre au niveau racine, PAS dans le payload !\n\n**3. UUID vs NumÃ©ro :**\n- **get-devis/get-facture** : Tu DOIS utiliser un UUID (utilise `list-devis` si tu n'as que le numÃ©ro)\n- **creer-facture-depuis-devis** : Tu peux utiliser le numÃ©ro directement (ex: \"DV-2025-042\") OU l'UUID\n- **envoyer-devis/envoyer-facture** : Tu DOIS utiliser un UUID\n\n**4. AprÃ¨s create-devis :**\n- La rÃ©ponse contient `data.devis.id` (UUID) et `data.devis.numero`\n- Tu DOIS conserver l'UUID (`data.devis.id`) pour get-devis/envoyer-devis !\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW CRÃ‰ATION FACTURE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND L'UTILISATEUR DEMANDE DE CRÃ‰ER UNE FACTURE :**\n\n1. Tu extrais le numÃ©ro du devis depuis la demande (ex: \"DV-2025-042\")\n2. Tu determines le type :\n   - Si l'utilisateur dit \"facture d'acompte\" â†’ type = \"acompte\"\n   - Si l'utilisateur dit \"facture intermÃ©diaire\" â†’ type = \"intermediaire\"\n   - Si l'utilisateur dit \"facture de solde\" â†’ type = \"solde\"\n   - Si l'utilisateur ne prÃ©cise pas â†’ type = \"acompte\" (par dÃ©faut)\n3. Tu appelles call_edge_function avec :\n```json\n{\n  \"action\": \"creer-facture-depuis-devis\",\n  \"payload\": {\n    \"devis_id\": \"[numÃ©ro du devis, ex: 'DV-2025-042', OU UUID]\",\n    \"type\": \"[acompte/intermediaire/solde]\"\n  },\n  \"tenant_id\": \"[EXTRAIRE depuis body.context.tenant_id]\"\n}\n```\n4. Si erreur ALREADY_EXISTS : tu affiches les factures existantes et proposes le type suivant\n5. Tu rÃ©cupÃ¨res la facture avec get-facture (utilise l'UUID de la rÃ©ponse)\n6. Tu affiches le rÃ©sumÃ© final avec pdf_url (mÃªme format que pour le devis)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWORKFLOW ENVOI EMAIL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**QUAND L'UTILISATEUR DEMANDE D'ENVOYER UN DEVIS/FACTURE PAR EMAIL :**\n\n1. Tu appelles get-devis ou get-facture (avec UUID, PAS le numÃ©ro)\n2. Tu composes un message : sujet + corps de l'email\n3. Tu affiches un rÃ©sumÃ© avec : destinataire, sujet, message complet, lien PDF\n4. Tu demandes confirmation : \"Souhaitez-vous que j'envoie cet email ?\"\n5. Tu attends la rÃ©ponse\n6. Si \"Oui\" â†’ tu appelles envoyer-devis/envoyer-facture (avec UUID)\n7. Tu confirmes l'envoi\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCHECKLIST AVANT CHAQUE MESSAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**AprÃ¨s le rÃ©sumÃ© initial (Ã‰TAPE 1) :**\n1. âœ… J'ai affichÃ© TOUTES les lignes de travaux (si body.travaux.length = 3, j'affiche 3 lignes) ?\n2. âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n3. âœ… J'ai posÃ© les questions (dÃ©lai d'exÃ©cution, adresse chantier, notes) ?\n4. âœ… J'ai demandÃ© confirmation ? (NON - tu ne demandes pas confirmation aprÃ¨s le rÃ©sumÃ© initial, tu poses les questions !)\n\n**AprÃ¨s les rÃ©ponses de l'utilisateur (Ã‰TAPE 2) :**\n1. âœ… Si l'utilisateur dit \"tout est correct\", je comprends que c'est une rÃ©ponse (pas une confirmation) ?\n2. âœ… Je passe Ã  l'Ã‰TAPE 3 (rÃ©sumÃ© final) et je ne crÃ©e pas encore ?\n\n**AprÃ¨s le rÃ©sumÃ© final (Ã‰TAPE 3) :**\n1. âœ… J'ai affichÃ© TOUTES les lignes de travaux Ã  nouveau (si body.travaux.length = 3, j'affiche 3 lignes) ?\n2. âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne) ?\n3. âœ… J'ai demandÃ© confirmation explicitement ?\n\n**Avant de crÃ©er (Ã‰TAPE 5) :**\n1. âœ… L'utilisateur a confirmÃ© explicitement (\"oui\", \"c'est bon\", \"vas-y\", \"crÃ©er\") APRÃˆS le rÃ©sumÃ© final ?\n2. âœ… J'ai bien posÃ© les questions et reÃ§u les rÃ©ponses avant de crÃ©er ?\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCHECKLIST AVANT CHAQUE APPEL call_edge_function\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. âœ… J'ai extrait tenant_id depuis body.context.tenant_id ?\n2. âœ… J'ai mis tenant_id au niveau racine (PAS dans payload) ?\n3. âœ… Pour add-ligne-devis : lignes.length = body.travaux.length ?\n4. âœ… J'ai inclus TOUTES les lignes de travaux (de 0 Ã  body.travaux.length - 1) ?\n   - âœ… J'ai inclus body.travaux[0] (la PREMIÃˆRE ligne, ne JAMAIS oublier celle-ci) ?\n   - âœ… J'ai inclus body.travaux[1] ?\n   - âœ… ... jusqu'Ã  body.travaux[length - 1] ?\n5. âœ… Dans mes rÃ©sumÃ©s, j'ai affichÃ© TOUTES les lignes de body.travaux (si length = 3, j'affiche 3 lignes, pas 2) ?\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRÃˆGLES DE FORMAT AFFICHAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n**Pour les lignes de travaux dans les rÃ©sumÃ©s :**\n- Tu affiches UNIQUEMENT : dÃ©signation - quantitÃ© unitÃ© Ã— prix â‚¬ HT\n- Tu n'affiches PAS les dÃ©tails HT/TVA/TTC pour chaque ligne individuelle\n- Tu affiches les totaux UNE SEULE FOIS Ã  la fin\n\n**Exemple CORRECT :**\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\nâ€¢ Rebouchage trous et fissures - 33 mÂ² Ã— 19 â‚¬ HT\nâ€¢ Peinture murs blanc mat - 33 mÂ² Ã— 30 â‚¬ HT\n\nðŸ’° TOTAL\nâ€¢ Total HT : 2 027,00 â‚¬\nâ€¢ TVA : 243,70 â‚¬\nâ€¢ Total TTC : 2 270,70 â‚¬\n```\n\n**Exemple INCORRECT (trop verbeux) :**\n```\nðŸ”¨ TRAVAUX PRÃ‰VUS\n\nâ€¢ Protection chantier - 1 forfait Ã— 410 â‚¬ HT\n  - Total HT: 410,00 â‚¬\n  - TVA: 20% â†’ 82,00 â‚¬\n  - Total TTC: 492,00 â‚¬\n```\n",
          "temperature": 0.7
        },
        "tools": {
          "values": [
            {
              "name": "call_edge_function",
              "description": "Point d'entrÃ©e unique pour toutes les opÃ©rations CRUD de LÃ‰O via leo-router. L'IA doit gÃ©nÃ©rer un JSON avec: { \"action\": \"...\", \"payload\": {...}, \"tenant_id\": \"...\" }",
              "type": "httpRequest",
              "httpRequest": {
                "url": "https://zhemkkukhxspakxvrmlr.supabase.co/functions/v1/leo-router",
                "method": "POST",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendHeaders": true,
                "headerParameters": {
                  "parameters": [
                    {
                      "name": "Authorization",
                      "value": "Bearer {{ $env.LEO_API_SECRET }}"
                    },
                    {
                      "name": "Content-Type",
                      "value": "application/json"
                    }
                  ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ JSON.stringify({ action: $json.action, payload: $json.payload, tenant_id: $json.tenant_id }) }}",
                "options": {}
              },
              "schema": {
                "type": "object",
                "properties": {
                  "action": {
                    "type": "string",
                    "description": "Action Ã  effectuer (ex: 'chercher-client', 'creer-client')"
                  },
                  "payload": {
                    "type": "object",
                    "description": "ParamÃ¨tres de l'action"
                  },
                  "tenant_id": {
                    "type": "string",
                    "description": "UUID du tenant depuis context.tenant_id"
                  }
                },
                "required": [
                  "action",
                  "payload",
                  "tenant_id"
                ]
              }
            }
          ]
        }
      },
      "id": "ai-agent-leo",
      "name": "AI Agent LÃ‰O",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.3,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format response pour l'utilisateur\nconst input = $input.item.json;\n\n// Extraire la rÃ©ponse de l'AI\nconst response = input.output || input.text || input.message || \"\";\n\nreturn {\n  message: response,\n  success: true\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.context.is_whatsapp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-response-type",
      "name": "Check Response Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "to": "={{ $json.context.phone || $json.body.phone }}",
        "message": "={{ $json.message }}",
        "options": {}
      },
      "id": "send-sms",
      "name": "Send SMS/WhatsApp",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        1850,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.message }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1850,
        400
      ]
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "Check Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Message Type": {
      "main": [
        [
          {
            "node": "Format Text Message for LEO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Audio Message for LEO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Text Message for LEO": {
      "main": [
        [
          {
            "node": "Merge Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Audio Message for LEO": {
      "main": [
        [
          {
            "node": "Merge Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Messages": {
      "main": [
        [
          {
            "node": "Extract Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Info": {
      "main": [
        [
          {
            "node": "AI Agent LÃ‰O",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent LÃ‰O": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Check Response Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Response Type": {
      "main": [
        [
          {
            "node": "Send SMS/WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-20T12:00:00.000Z",
  "versionId": "1"
}